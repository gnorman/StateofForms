{% extends 'core/base.html' %}

{% block title %}Stock Queries - queryForge{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Stock Market Data Query
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Query real-time and historical stock market data from global exchanges.</p>
                    
                    <form id="stockForm" method="post">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="symbol" class="form-label">
                                    <i class="fas fa-building me-1"></i>
                                    Stock Symbol
                                </label>
                                <select class="form-select" id="symbol" name="symbol" required>
                                    <option value="">Select a stock...</option>
                                    <optgroup label="Popular Stocks">
                                        <option value="AAPL">Apple Inc. (AAPL)</option>
                                        <option value="MSFT">Microsoft Corporation (MSFT)</option>
                                        <option value="GOOGL">Alphabet Inc. (GOOGL)</option>
                                        <option value="AMZN">Amazon.com Inc. (AMZN)</option>
                                        <option value="TSLA">Tesla Inc. (TSLA)</option>
                                        <option value="META">Meta Platforms Inc. (META)</option>
                                        <option value="NVDA">NVIDIA Corporation (NVDA)</option>
                                        <option value="NFLX">Netflix Inc. (NFLX)</option>
                                    </optgroup>
                                    <optgroup label="Financial">
                                        <option value="JPM">JPMorgan Chase & Co. (JPM)</option>
                                        <option value="BAC">Bank of America Corp (BAC)</option>
                                        <option value="WFC">Wells Fargo & Company (WFC)</option>
                                        <option value="GS">Goldman Sachs Group Inc (GS)</option>
                                    </optgroup>
                                    <optgroup label="Healthcare">
                                        <option value="JNJ">Johnson & Johnson (JNJ)</option>
                                        <option value="PFE">Pfizer Inc. (PFE)</option>
                                        <option value="UNH">UnitedHealth Group Inc (UNH)</option>
                                        <option value="ABBV">AbbVie Inc. (ABBV)</option>
                                    </optgroup>
                                </select>
                                <div class="form-text">Or enter a custom symbol below</div>
                            </div>
                            <div class="col-md-6">
                                <label for="custom_symbol" class="form-label">
                                    <i class="fas fa-keyboard me-1"></i>
                                    Custom Symbol
                                </label>
                                <input type="text" class="form-control" id="custom_symbol" name="custom_symbol" placeholder="e.g., TSLA, GOOGL, etc.">
                                <div class="form-text">Leave blank to use selection above</div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="period" class="form-label">
                                    <i class="fas fa-clock me-1"></i>
                                    Data Period
                                </label>
                                <select class="form-select" id="period" name="period">
                                    <option value="">Real-time (current price)</option>
                                    <option value="1d">1 Day</option>
                                    <option value="5d">5 Days</option>
                                    <option value="1mo">1 Month</option>
                                    <option value="3mo">3 Months</option>
                                    <option value="6mo">6 Months</option>
                                    <option value="1y">1 Year</option>
                                    <option value="2y">2 Years</option>
                                    <option value="5y">5 Years</option>
                                    <option value="10y">10 Years</option>
                                    <option value="max">Maximum Available</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="interval" class="form-label">
                                    <i class="fas fa-stopwatch me-1"></i>
                                    Data Interval
                                </label>
                                <select class="form-select" id="interval" name="interval">
                                    <option value="1d">Daily</option>
                                    <option value="1h">Hourly</option>
                                    <option value="1m">1 Minute</option>
                                    <option value="5m">5 Minutes</option>
                                    <option value="15m">15 Minutes</option>
                                    <option value="30m">30 Minutes</option>
                                    <option value="1wk">Weekly</option>
                                    <option value="1mo">Monthly</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3" id="customDateRange" style="display: none;">
                            <div class="col-md-6">
                                <label for="start_date" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    Start Date
                                </label>
                                <input type="date" class="form-control" id="start_date" name="start_date">
                            </div>
                            <div class="col-md-6">
                                <label for="end_date" class="form-label">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    End Date
                                </label>
                                <input type="date" class="form-control" id="end_date" name="end_date">
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="customDates" name="custom_dates">
                                <label class="form-check-label" for="customDates">
                                    Use custom date range instead of period
                                </label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-search me-2"></i>
                                Query Stock Market Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="results" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Query Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('customDates').addEventListener('change', function() {
    const customDateRange = document.getElementById('customDateRange');
    const periodSelect = document.getElementById('period');
    
    if (this.checked) {
        customDateRange.style.display = 'block';
        periodSelect.disabled = true;
    } else {
        customDateRange.style.display = 'none';
        periodSelect.disabled = false;
    }
});

document.getElementById('custom_symbol').addEventListener('input', function() {
    const symbolSelect = document.getElementById('symbol');
    if (this.value.trim()) {
        symbolSelect.disabled = true;
        symbolSelect.value = '';
    } else {
        symbolSelect.disabled = false;
    }
});

document.getElementById('symbol').addEventListener('change', function() {
    const customSymbol = document.getElementById('custom_symbol');
    if (this.value) {
        customSymbol.disabled = true;
        customSymbol.value = '';
    } else {
        customSymbol.disabled = false;
    }
});

document.getElementById('stockForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const formObject = Object.fromEntries(formData);
    
    // Use custom symbol if provided, otherwise use selected symbol
    let symbol = formObject.symbol;
    if (formObject.custom_symbol && formObject.custom_symbol.trim()) {
        symbol = formObject.custom_symbol.trim().toUpperCase();
    }
    
    // Prepare payload for backend
    const payload = {
        symbol: symbol,
        limit: 100
    };
    
    // Handle date logic
    if (formObject.custom_dates === 'on' && formObject.start_date && formObject.end_date) {
        payload.start_date = formObject.start_date;
        payload.end_date = formObject.end_date;
    } else if (formObject.period) {
        // Calculate dates based on period
        const today = new Date();
        const endDate = today.toISOString().split('T')[0];
        
        let startDate;
        switch(formObject.period) {
            case '1d':
                startDate = new Date(today.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '5d':
                startDate = new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '1mo':
                startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '3mo':
                startDate = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '6mo':
                startDate = new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '1y':
                startDate = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '2y':
                startDate = new Date(today.getTime() - 730 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '5y':
                startDate = new Date(today.getTime() - 1825 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '10y':
                startDate = new Date(today.getTime() - 3650 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            default:
                // For real-time or max, don't set dates
                break;
        }
        
        if (startDate) {
            payload.start_date = startDate;
            payload.end_date = endDate;
        }
    }
    
    // Show loading state
    document.getElementById('results').style.display = 'block';
    document.getElementById('resultContent').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Fetching stock market data...</div>';
    
    // Submit to backend
    fetch('/api/stock/query', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('resultContent').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    })
    .catch(error => {
        document.getElementById('resultContent').innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error.message + '</div>';
    });
});
</script>
{% endblock %}