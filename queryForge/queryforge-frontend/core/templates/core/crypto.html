{% extends 'core/base.html' %}

{% block title %}Crypto Queries - queryForge{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-bitcoin me-2"></i>
                        Cryptocurrency Data Query
                    </h4>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">Query real-time and historical cryptocurrency data from various exchanges.</p>
                    
                    <form id="cryptoForm" method="post">
                        {% csrf_token %}
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="symbol" class="form-label">
                                    <i class="fas fa-coins me-1"></i>
                                    Cryptocurrency Symbol
                                </label>
                                <select class="form-select" id="symbol" name="symbol" required>
                                    <option value="">Select a cryptocurrency...</option>
                                    <option value="BTC-USD">Bitcoin (BTC-USD)</option>
                                    <option value="ETH-USD">Ethereum (ETH-USD)</option>
                                    <option value="ADA-USD">Cardano (ADA-USD)</option>
                                    <option value="DOT-USD">Polkadot (DOT-USD)</option>
                                    <option value="LINK-USD">Chainlink (LINK-USD)</option>
                                    <option value="LTC-USD">Litecoin (LTC-USD)</option>
                                    <option value="XRP-USD">Ripple (XRP-USD)</option>
                                    <option value="SOL-USD">Solana (SOL-USD)</option>
                                    <option value="MATIC-USD">Polygon (MATIC-USD)</option>
                                    <option value="AVAX-USD">Avalanche (AVAX-USD)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="period" class="form-label">
                                    <i class="fas fa-clock me-1"></i>
                                    Data Period
                                </label>
                                <select class="form-select" id="period" name="period">
                                    <option value="">Real-time (current price)</option>
                                    <option value="1d">1 Day</option>
                                    <option value="5d">5 Days</option>
                                    <option value="1mo">1 Month</option>
                                    <option value="3mo">3 Months</option>
                                    <option value="6mo">6 Months</option>
                                    <option value="1y">1 Year</option>
                                    <option value="2y">2 Years</option>
                                    <option value="5y">5 Years</option>
                                    <option value="max">Maximum Available</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3" id="customDateRange" style="display: none;">
                            <div class="col-md-6">
                                <label for="start_date" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    Start Date
                                </label>
                                <input type="date" class="form-control" id="start_date" name="start_date">
                            </div>
                            <div class="col-md-6">
                                <label for="end_date" class="form-label">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    End Date
                                </label>
                                <input type="date" class="form-control" id="end_date" name="end_date">
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="customDates" name="custom_dates">
                                <label class="form-check-label" for="customDates">
                                    Use custom date range instead of period
                                </label>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="fas fa-search me-2"></i>
                                Query Cryptocurrency Data
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="results" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Query Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="resultContent"></div>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <a href="{% url 'index' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('customDates').addEventListener('change', function() {
    const customDateRange = document.getElementById('customDateRange');
    const periodSelect = document.getElementById('period');
    
    if (this.checked) {
        customDateRange.style.display = 'block';
        periodSelect.disabled = true;
    } else {
        customDateRange.style.display = 'none';
        periodSelect.disabled = false;
    }
});

document.getElementById('cryptoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const formObject = Object.fromEntries(formData);
    
    // Prepare payload for backend
    const payload = {
        symbol: formObject.symbol,
        limit: 100
    };
    
    // Handle date logic
    if (formObject.custom_dates === 'on' && formObject.start_date && formObject.end_date) {
        payload.start_date = formObject.start_date;
        payload.end_date = formObject.end_date;
    } else if (formObject.period) {
        // For periods, let backend handle the date calculation
        // We can add period support later or calculate dates here
        const today = new Date();
        const endDate = today.toISOString().split('T')[0];
        
        let startDate;
        switch(formObject.period) {
            case '1d':
                startDate = new Date(today.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '5d':
                startDate = new Date(today.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '1mo':
                startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '3mo':
                startDate = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '6mo':
                startDate = new Date(today.getTime() - 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '1y':
                startDate = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '2y':
                startDate = new Date(today.getTime() - 730 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            case '5y':
                startDate = new Date(today.getTime() - 1825 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                break;
            default:
                // For real-time or max, don't set dates
                break;
        }
        
        if (startDate) {
            payload.start_date = startDate;
            payload.end_date = endDate;
        }
    }
    
    // Show loading state
    document.getElementById('results').style.display = 'block';
    document.getElementById('resultContent').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>Fetching cryptocurrency data...</div>';
    
    // Submit to backend
    fetch('/api/crypto/query', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('resultContent').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
    })
    .catch(error => {
        document.getElementById('resultContent').innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error.message + '</div>';
    });
});
</script>
{% endblock %}